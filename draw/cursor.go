package draw

import (
	"os"
)

// Cursor represents a mouse cursor image.
type Cursor struct {
	Offset Point        // offset from hotspot to corner
	Clr    [2 * 16]byte // 1-bit color
	Set    [2 * 16]byte // 1-bit mask
}

// Cursor2 is a high-resolution cursor (32x32).
type Cursor2 struct {
	Offset Point        // offset from hotspot to corner
	Clr    [2 * 32]byte // 1-bit color
	Set    [2 * 32]byte // 1-bit mask
}

// SetCursor sets the mouse cursor image.
func (d *Display) SetCursor(c *Cursor) error {
	if c == nil {
		return d.setCursorDefault()
	}

	cctl, err := os.OpenFile("/dev/cursor", os.O_WRONLY, 0)
	if err != nil {
		return err
	}
	defer cctl.Close()

	// Write cursor data
	// Format: offset.x[4] offset.y[4] clr[2*16] set[2*16]
	buf := make([]byte, 4+4+2*16+2*16)
	bplong(buf[0:], uint32(c.Offset.X))
	bplong(buf[4:], uint32(c.Offset.Y))
	copy(buf[8:], c.Clr[:])
	copy(buf[8+2*16:], c.Set[:])

	_, err = cctl.Write(buf)
	return err
}

// SetCursor2 sets a high-resolution cursor.
func (d *Display) SetCursor2(c *Cursor, c2 *Cursor2) error {
	// For systems that support 32x32 cursors
	// Fall back to regular SetCursor
	return d.SetCursor(c)
}

// setCursorDefault resets to the default cursor.
func (d *Display) setCursorDefault() error {
	cctl, err := os.OpenFile("/dev/cursor", os.O_WRONLY, 0)
	if err != nil {
		return err
	}
	defer cctl.Close()

	// Write empty cursor to reset
	_, err = cctl.Write([]byte{})
	return err
}

// Standard cursor shapes
var (
	// Arrow cursor (default)
	ArrowCursor = &Cursor{
		Offset: Pt(-1, -1),
		Clr: [2 * 16]byte{
			0xFF, 0xFF, 0x80, 0x01, 0x80, 0x02, 0x80, 0x0C,
			0x80, 0x10, 0x80, 0x10, 0x80, 0x08, 0x80, 0x04,
			0x80, 0x02, 0x80, 0x01, 0x80, 0x02, 0x8C, 0x04,
			0x92, 0x08, 0x91, 0x10, 0xA0, 0xA0, 0xC0, 0x40,
		},
		Set: [2 * 16]byte{
			0x00, 0x00, 0x7F, 0xFE, 0x7F, 0xFC, 0x7F, 0xF0,
			0x7F, 0xE0, 0x7F, 0xE0, 0x7F, 0xF0, 0x7F, 0xF8,
			0x7F, 0xFC, 0x7F, 0xFE, 0x7F, 0xFC, 0x73, 0xF8,
			0x61, 0xF0, 0x60, 0xE0, 0x40, 0x40, 0x00, 0x00,
		},
	}

	// Crosshair cursor
	CrossCursor = &Cursor{
		Offset: Pt(-7, -7),
		Clr: [2 * 16]byte{
			0x00, 0x00, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80,
			0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x7F, 0xFE,
			0x7F, 0xFE, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80,
			0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x00, 0x00,
		},
		Set: [2 * 16]byte{
			0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0,
			0x03, 0xC0, 0x03, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF,
			0xFF, 0xFF, 0xFF, 0xFF, 0x03, 0xC0, 0x03, 0xC0,
			0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0, 0x03, 0xC0,
		},
	}

	// Watch/busy cursor
	WatchCursor = &Cursor{
		Offset: Pt(-7, -7),
		Clr: [2 * 16]byte{
			0x00, 0x00, 0x7F, 0xFE, 0x7F, 0xFE, 0x70, 0x0E,
			0x70, 0x0E, 0x70, 0x0E, 0x70, 0x0E, 0x73, 0xCE,
			0x73, 0xCE, 0x70, 0x0E, 0x70, 0x0E, 0x70, 0x0E,
			0x70, 0x0E, 0x7F, 0xFE, 0x7F, 0xFE, 0x00, 0x00,
		},
		Set: [2 * 16]byte{
			0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
			0xF0, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F,
			0xF0, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F,
			0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		},
	}
)
